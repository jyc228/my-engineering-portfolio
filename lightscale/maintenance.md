# 이더리움 L2 네트워크 유지보수

## 프로젝트 개요

- 기간: 2023.5 - 2024.10 (약 17개월)
- 인원: 4명
- 핵심 기술: golang
- 주요 역할: 설계, 개발, 지식 전파

## 주요 업무

### 프로젝트 수행

- [zktrie.md](zktrie.md)
- [snapsync.md](snapsync.md)

프로젝트를 수행하며 발견한 치명적인 문제는, `geth` 표준 테스트 코드의 80% 이상이 `mpt` 자료구조를 전제로 작성되어 있어
조직의 핵심 구현체인 `zktrie`에 대한 동작 보증이 이더리움 코어 시스템과 연결이 되지 않는다 라는 결함을 의미했습니다.
이 사태를 해결하기 위하여 2가지를 시도 했습니다.

1. **기존 테스트 수정** : 테스트를 `zktrie`에 맞게 수정하려 했으나, upstream 관점에서의 diff 가 너무 커 유지보수 리스크가 높다고 판단했습니다.
2. **외부 툴 활용**: 테스트 네트워크에서 외부 검증 툴을 통한 블랙박스 테스트를 시도하며 보완하려 했습니다.

최종적으로 외부 툴 도입까지 완결 짓지는 못했으나, 팀원들 모두가 매우 위험한 상태라는걸 인지하게 되었습니다. 제가 만들었던 버그 또한, 테스트가 돌았더라면 방어됐을수도 있었을 것입니다.
이는 이후 제가 **`mpt`로의 마이그레이션** 를 강력하게 주장하게 된 결정적인 근거 중 하나가 되었습니다.

### geth 파악 및 지식 전파

`geth` 는 손꼽힐정도로 복잡한 소프트웨어입니다. 조직은 직접적으로 `geth` 를 수정하고 운영하였으므로, 저는 모든 계층에 대한 일정 수준이상의 지식이 반드시 필요하다고 생각했습니다.
그래서 개인적으로 [kotlin 으로 geth 를 구현하는 프로젝트](./../personal/keth.md)를 진행하면서, 조직 업무를 통해 얻은 지식으로 주기적인 세미나를 진행했습니다.

제가 블록체인 코어 업무를 그만둔 이후에 조직은 `zktrie` 를 `mpt` 로 전환을 두고 고민을 했었습니다. 저는 `mpt` 로 가는게 장기적으로 유리하다 라고 생각을 해서 주장했고,
팀은 `mpt` 로 전환을 결정했습니다. 그 후 `trie` 마이그레이션 핵심 로직은 제가 개발한 후 동료 개발자에게 전달 했고, 그동안 전파한 지식과 합쳐져서
동료 개발자는 무중단 마이그레이션을 무사히 해낼 수 있었습니다.

### upstream

`geth` 는 활발히 수정되고 있는 프로젝트 입니다.

조직에서 커스텀한 `geth` 는 기본적으론 한차례 이미 개조된 `op-geth` 를 기준으로, `scroll-geth` 라는 구현체의 특정 부분을 섞고, 자체 커스텀까지 한 하이브리드 프로젝트 였습니다.
다른 L2 네트워크 대비 경쟁력을 잃지 않기 위하여, 팀은 주기적으로 upstream 을 하기로 결정했으며, 이를 위하여 코어 소스코드의 변경을 최소화 하자고 의결했습니다.
저는 이 상태에서 주기적으로 upstream 할 때 마다, `geth` 의 패치 내용을 커밋 단위로 전수 검수하고, 이를 통해 알게된 새로운 패치 내역이나 중요한 변경을 전파했습니다.

### 운영 및 장애 대응

기본적으론 블록체인은 마스터 노드가 없어야 하지만, L2 네트워크는 프로젝트의 성숙도가 올라가기 전까진, 주 개발 회사가 사실상 마스터노드 운영하듯이 운영을 하는 경우가 많습니다.
저희도 그랬기 때문에 파트너사 `node` 모니터링, `geth` 모니터링, `sequencer` 모니터링, `validator` 모니터링 등..
다양한 지표를 수집하며 네트워크가 안정적으로 유지될 수 있도록 노력했습니다.

이 기간동안 가장 큰 장애는 2번 있었으며, 모두 저와 관련이 매우 깊었고, 책임지고 끝까지 해결하려고 노력했습니다.

1. 2024-01 트래픽 폭증으로 인한 체인 성능 저하 : 저는 [zktrie](./zktrie.md) 성능 문제를 6개월 전부터 예견했었고, 이를 지속적으로 말해왔었습니다.
   그러다 실제로 발생했었으며 저는 빠르고 정확한 원인을 진단하고 임시 해결책을 내놨으며, 동시에 근본적인 해결책도 제시했습니다. 자세한 설명은 [zktrie](./zktrie.md) 문서를 확인해 주세요.
2. 잘못된 zktrie 구현 으로 인한 합의 실패 : 성능 저하 사태가 발생한 이후, 제가 구현중이던 신규 구현체만이 근본적인 해결책이었으므로 빠르게 적용했다가,
   로직 결함으로 인하여 합의에 실패했고, 데이터를 유실했습니다. 이 상태에서 빠르게 대응 방안을 제시했고, 팀원들과 같이 네트워크가 회복될 수 있도록 노력했습니다.
   이 또한 [zktrie](./zktrie.md) 를 통해 확인하실 수 있습니다.